<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Census Step 1</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Uber+Move:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Uber Move', sans-serif;
      background: #000;
      color: #fff;
      display: flex;
      justify-content: center;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      background: #111;
      border-radius: 16px;
      padding: 20px;
      width: 100%;
      max-width: 500px;
    }

    h1 {
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 16px;
      color: #f2d0b5;
    }

    .profile-header {
      background: #222;
      padding: 12px 14px;
      border-radius: 12px;
      margin-bottom: 16px;
      font-size: 0.95rem;
      line-height: 1.5;
      text-align: center;
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      font-size: 0.85rem;
      color: #ccc;
      display: block;
      margin-bottom: 5px;
    }

    input {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      background: #222;
      border: none;
      color: #fff;
      font-size: 0.95rem;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      background: #774936;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 12px;
    }

    button:hover {
      background: #5e3729;
    }

    .section-title {
      margin: 30px 0 10px;
      font-size: 1.1rem;
      border-bottom: 1px solid #444;
      padding-bottom: 6px;
      color: #d6b392;
    }

    .toast {
      display: none;
      background: #774936;
      padding: 12px;
      color: white;
      border-radius: 10px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      z-index: 999;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Census Step 1</h1>

    <div id="profileHeader" class="profile-header hidden"></div>

    <div id="profileForm">
      <div class="form-group"><label>Participant</label><input type="text" id="participant" /></div>
      <div class="form-group"><label>Project Code</label><input type="text" id="projectCode" /></div>
      <div class="form-group"><label>Dip Tank</label><input type="text" id="dipTank" /></div>
      <div class="form-group"><label>CAHW Name</label><input type="text" id="cahwName" /></div>
      <div class="form-group"><label>Village</label><input type="text" id="village" /></div>
      <div class="form-group"><label>Cell Number</label><input type="tel" id="cellNumber" /></div>
      <button onclick="saveProfile()">Let's Go üöÄ</button>
    </div>

    <div id="censusSection" class="hidden">
      <div class="section-title">üè† Household Info</div>
      <div class="form-group"><label>Municipal Number</label><input type="text" id="municipalNumber" /></div>
      <div class="form-group"><label>Date</label><input type="text" id="date" readonly /></div>
      <div class="form-group"><label>Farmer Name</label><input type="text" id="farmerName" /></div>
      <div class="form-group"><label>Farmer Cell</label><input type="tel" id="farmerCell" /></div>
      <div class="form-group"><label>Male</label><input type="number" id="male" min="0" /></div>
      <div class="form-group"><label>Female</label><input type="number" id="female" min="0" /></div>
      <div class="form-group"><label>Youth</label><input type="number" id="youth" min="0" /></div>
      <div class="form-group"><label>Adult</label><input type="number" id="adult" min="0" /></div>
      <div class="form-group"><label>Persons with Disability</label><input type="number" id="disability" min="0" /></div>

      <div class="section-title">üêÑ Cattle Info</div>
      <div class="form-group"><label>Total Cows</label><input type="number" id="cows" min="0" /></div>
      <div class="form-group"><label>Cows Used (last 6 months)</label><input type="number" id="cowsUsed" min="0" /></div>
      <div class="form-group"><label>Cows Sold</label><input type="number" id="cowsSold" min="0" /></div>
      <div class="form-group"><label>Cows Stolen</label><input type="number" id="cowsStolen" min="0" /></div>
      <div class="form-group"><label>Cows Died</label><input type="number" id="cowsDied" min="0" /></div>

      <button onclick="submitCensus()">Save & Next ‚û°</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCaOrMKZXZtJKD646bARehuTOxCe4DzsLk",
      authDomain: "hpsa-app-6b2d2.firebaseapp.com",
      projectId: "hpsa-app-6b2d2",
      storageBucket: "hpsa-app-6b2d2.appspot.com",
      messagingSenderId: "445389782453",
      appId: "1:445389782453:web:595647fa1038fab9886dfc"
    };

    initializeApp(firebaseConfig);
    const db = getFirestore();

    const profileHeader = document.getElementById("profileHeader");
    const profileForm = document.getElementById("profileForm");
    const censusSection = document.getElementById("censusSection");

    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.remove("hidden");
      toast.style.display = "block";
      setTimeout(() => {
        toast.style.display = "none";
        toast.classList.add("hidden");
      }, 2500);
    }

    function initPage() {
      const saved = JSON.parse(localStorage.getItem("censusUserProfile") || "{}");
      const captured = sessionStorage.getItem("profileCaptured") === "true";

      document.getElementById("participant").value = saved.participant || "";
      document.getElementById("projectCode").value = saved.projectCode || "";
      document.getElementById("date").value = new Date().toISOString().split("T")[0];

      if (captured && saved.participant) {
        showProfileHeader(saved);
        profileForm.classList.add("hidden");
        censusSection.classList.remove("hidden");
      }
    }

    function showProfileHeader(p) {
      profileHeader.classList.remove("hidden");
      profileHeader.innerHTML = `
        <strong>${p.participant}</strong> | ${p.projectCode}<br>
        üìç ${p.village} | üíß ${p.dipTank}<br>
        üì± ${p.cellNumber} | üë© ${p.cahwName}
      `;
    }

    window.saveProfile = function () {
      const profile = {
        participant: document.getElementById("participant").value.trim(),
        projectCode: document.getElementById("projectCode").value.trim(),
        dipTank: document.getElementById("dipTank").value.trim(),
        cahwName: document.getElementById("cahwName").value.trim(),
        village: document.getElementById("village").value.trim(),
        cellNumber: document.getElementById("cellNumber").value.trim()
      };

      for (const [key, value] of Object.entries(profile)) {
        if (!value) {
          showToast(`‚ö†Ô∏è Please fill in ${key.replace(/([A-Z])/g, ' $1')}`);
          return;
        }
      }

      localStorage.setItem("censusUserProfile", JSON.stringify(profile));
      sessionStorage.setItem("profileCaptured", "true");

      showProfileHeader(profile);
      profileForm.classList.add("hidden");
      censusSection.classList.remove("hidden");
    };

    window.submitCensus = function () {
      const requiredFields = [
        "municipalNumber", "date", "farmerName", "farmerCell",
        "male", "female", "youth", "adult", "disability",
        "cows", "cowsUsed", "cowsSold", "cowsStolen", "cowsDied"
      ];

      for (let id of requiredFields) {
        const val = document.getElementById(id).value.trim();
        if (!val) {
          showToast(`‚ö†Ô∏è ${id.replace(/([A-Z])/g, ' $1')} is required`);
          return;
        }
      }

      const profile = JSON.parse(localStorage.getItem("censusUserProfile") || "{}");
      const data = {};
      requiredFields.forEach(id => data[id] = document.getElementById(id).value.trim());

      const fullRecord = { ...profile, ...data };
      sessionStorage.setItem("censusStep1", JSON.stringify(fullRecord));
      showToast("‚úÖ Saved. Redirecting...");
      setTimeout(() => window.location.href = "sensus-household.html", 1200);

    };

    initPage();
  </script>
</body>
</html>
