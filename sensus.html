<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Census Step 1</title>
<link href="https://fonts.googleapis.com/css2?family=Uber+Move:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{
  --navy-900:#002C5F;
  --navy-800:#003A73;
  --accent-red:#e63946;
  --green:#00A99D;
  --light-brown:#7EDDD3;
  --white:#ffffff;
  --shadow:0 10px 25px rgba(0,44,95,0.35);
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:'Uber Move',sans-serif;
  min-height:100vh; display:flex; justify-content:center; align-items:flex-start;
  background: linear-gradient(135deg,#14243d,#0b1320);
  padding:20px; color:var(--white);
}
.container{
  width:100%; max-width:520px; padding:30px 20px; background:var(--light-brown);
  border-radius:16px; box-shadow:var(--shadow); position:relative;
}
h1.section-title{
  text-align:center; margin-bottom:25px; font-size:22px; font-weight:800; color:var(--navy-900);
}
.icon-label { font-size:1.8rem; margin-right:6px; vertical-align:middle; }
.home-btn{
  position:absolute; top:15px; right:15px; width:40px; height:40px; border-radius:12px;
  background:var(--navy-800); color:#fff; border:none; font-size:20px; cursor:pointer; display:grid; place-items:center;
}
.home-btn:hover{opacity:0.9;}
.profile-card{
  background:var(--navy-800); color:#fff; border-radius:12px; padding:16px; margin-bottom:20px;
  box-shadow:var(--shadow); font-size:15px; display:flex; flex-direction:column; gap:6px;
}
.form-group{margin-bottom:14px;}
label{display:block; font-size:14px; margin-bottom:6px; color:var(--navy-900); font-weight:700;}
input, select{
  width:100%; padding:12px; border-radius:10px; border:1px solid #ccc;
  background:#fff; color:#111; font-size:1rem;
}
input:focus, select:focus{outline:none; border-color:var(--navy-900);}
button.submit-btn{
  width:100%; padding:14px; margin-top:10px; border:none; border-radius:12px;
  background:linear-gradient(90deg,var(--accent-red),var(--navy-800)); color:#fff; font-weight:800; cursor:pointer;
  box-shadow:var(--shadow);
}
button.submit-btn:hover{opacity:0.9;}
button.submit-btn:disabled{background:#ccc; cursor:not-allowed; box-shadow:none;}
.toast {
  position: fixed; bottom: 20px; left:50%; transform:translateX(-50%);
  background: var(--navy-800); color: #fff; padding: 14px 20px; border-radius: 12px;
  font-weight: 600; box-shadow: var(--shadow); opacity: 0; transition: all 0.4s ease; z-index: 9999;
}
.toast.show { opacity: 1; }
@media(max-width:480px){
  .container{padding:20px;}
  .home-btn{width:36px;height:36px;font-size:18px;}
  .icon-label{font-size:1.5rem;}
}
</style>
</head>
<body>

<div class="container">
  <button class="home-btn" onclick="window.location.href='index.html'">üè†</button>
  <h1 class="section-title">üìä Census Info</h1>

  <div id="profileCard" class="profile-card" style="display:none;"></div>

  <div id="profileForm">
    <div class="form-group"><label>Participant</label><input type="text" id="participant" /></div>
    <div class="form-group"><label>Project Code</label><input type="text" id="projectCode" /></div>
    <div class="form-group"><label>Dip Tank</label><input type="text" id="dipTank" /></div>
    <div class="form-group"><label>CAHW Name</label><input type="text" id="cahwName" /></div>
    <div class="form-group"><label>Village</label><input type="text" id="village" /></div>
    <div class="form-group"><label>Cell Number</label><input type="tel" id="cellNumber" /></div>
    <button type="button" class="submit-btn" onclick="saveProfile()">Let's Go üöÄ</button>
  </div>

  <div id="censusForm" style="display:none;">
    <div class="form-group"><label><span class="icon-label">üè†</span> Municipal Number *</label><input type="text" id="municipalNumber" required/></div>
    <div class="form-group"><label>Date</label><input type="text" id="date" readonly/></div>
    <div class="form-group"><label>Farmer Name *</label><input type="text" id="farmerName" required/></div>
    <div class="form-group"><label>Farmer Cell *</label><input type="tel" id="farmerCell" required/></div>
    <div class="form-group"><label>Male *</label><input type="number" id="male" min="0" required/></div>
    <div class="form-group"><label>Female *</label><input type="number" id="female" min="0" required/></div>
    <div class="form-group"><label>Youth *</label><input type="number" id="youth" min="0" required/></div>
    <div class="form-group"><label>Adult *</label><input type="number" id="adult" min="0" required/></div>
    <div class="form-group"><label>Persons with Disability *</label><input type="number" id="disability" min="0" required/></div>
    <div class="form-group"><label><span class="icon-label">üêÑ</span> Total Cows *</label><input type="number" id="cows" min="0" required/></div>
    <div class="form-group"><label>Cows Used (last 6 months) *</label><input type="number" id="cowsUsed" min="0" required/></div>
    <div class="form-group"><label>Cows Sold *</label><input type="number" id="cowsSold" min="0" required/></div>
    <div class="form-group"><label>Cows Stolen *</label><input type="number" id="cowsStolen" min="0" required/></div>
    <div class="form-group"><label>Cows Died *</label><input type="number" id="cowsDied" min="0" required/></div>
    <button id="saveNextBtn" onclick="submitCensus()" class="submit-btn" disabled>Save & Next ‚û°</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCaOrMKZXZtJKD646bARehuTOxCe4DzsLk",
  authDomain: "hpsa-app-6b2d2.firebaseapp.com",
  projectId: "hpsa-app-6b2d2",
  storageBucket: "hpsa-app-6b2d2.appspot.com",
  messagingSenderId: "445389782453",
  appId: "1:445389782453:web:595647fa1038fab9886dfc"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function showToast(msg){
  const toast = document.getElementById("toast");
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"),2500);
}

// Load stored project code
const projectInput = document.getElementById("projectCode");
const storedPC = localStorage.getItem("projectCode");
if(storedPC) projectInput.value = storedPC;

// Save profile
window.saveProfile = function(){
  const profile = {
    participant: document.getElementById("participant").value.trim(),
    projectCode: projectInput.value.trim(),
    dipTank: document.getElementById("dipTank").value.trim(),
    cahwName: document.getElementById("cahwName").value.trim(),
    village: document.getElementById("village").value.trim(),
    cellNumber: document.getElementById("cellNumber").value.trim()
  };
  if(Object.values(profile).some(v => !v)){
    showToast("‚ö† Please fill all profile fields."); return;
  }
  localStorage.setItem("censusUserProfile", JSON.stringify(profile));
  localStorage.setItem("projectCode", profile.projectCode);
  
  // Show profile card
  document.getElementById("profileForm").style.display = "none";
  const card = document.getElementById("profileCard");
  card.innerHTML = `
    <div><strong>${profile.participant}</strong> | ${profile.projectCode}</div>
    <div>üìç ${profile.village} | üíß ${profile.dipTank}</div>
    <div>üì± ${profile.cellNumber} | üë© ${profile.cahwName}</div>
  `;
  card.style.display = "block";
  showToast("‚úÖ Profile saved. Fill census info below");
  document.getElementById("censusForm").style.display = "block";
};

// Initialize date
window.addEventListener("DOMContentLoaded",()=>{ 
  document.getElementById("date").value = new Date().toISOString().split("T")[0];
  enableSaveButton();
});

// Enable Save button only when all required fields filled
function enableSaveButton(){
  const numericFields = [
    "municipalNumber","farmerName","farmerCell",
    "male","female","youth","adult","disability",
    "cows","cowsUsed","cowsSold","cowsStolen","cowsDied"
  ];
  const allFilled = numericFields.every(id => document.getElementById(id).value.trim() !== "");
  document.getElementById("saveNextBtn").disabled = !allFilled;
}

// Attach input listeners
[
  "municipalNumber","farmerName","farmerCell",
  "male","female","youth","adult","disability",
  "cows","cowsUsed","cowsSold","cowsStolen","cowsDied"
].forEach(id => document.getElementById(id).addEventListener("input", enableSaveButton));

// Offline queue
function enqueueCensus(data){
  const queue = JSON.parse(localStorage.getItem("censusQueue")||"[]");
  queue.push(data);
  localStorage.setItem("censusQueue", JSON.stringify(queue));
}

// Auto-sync
async function syncQueue(){
  const queue = JSON.parse(localStorage.getItem("censusQueue")||"[]");
  if(queue.length && navigator.onLine){
    for(const data of queue){
      try{ await addDoc(collection(db,'census-users'), data); } 
      catch(e){ console.error(e); return; }
    }
    localStorage.removeItem("censusQueue");
    showToast("‚úÖ Offline census entries synced!");
  }
}
window.addEventListener("online", syncQueue);

// Submit Census
window.submitCensus = async function(){
  const profile = JSON.parse(localStorage.getItem("censusUserProfile")||"{}");
  const data = {
    ...profile,
    municipalNumber: document.getElementById("municipalNumber").value.trim(),
    date: document.getElementById("date").value,
    farmerName: document.getElementById("farmerName").value.trim(),
    farmerCell: document.getElementById("farmerCell").value.trim(),
    male: Number(document.getElementById("male").value),
    female: Number(document.getElementById("female").value),
    youth: Number(document.getElementById("youth").value),
    adult: Number(document.getElementById("adult").value),
    disability: Number(document.getElementById("disability").value),
    cows: Number(document.getElementById("cows").value),
    cowsUsed: Number(document.getElementById("cowsUsed").value),
    cowsSold: Number(document.getElementById("cowsSold").value),
    cowsStolen: Number(document.getElementById("cowsStolen").value),
    cowsDied: Number(document.getElementById("cowsDied").value),
    timestamp: new Date().toISOString()
  };

  if(navigator.onLine){
    try{
      await addDoc(collection(db,'census-report'), data);
      showToast("‚úÖ Census saved. Redirecting...");
      setTimeout(()=>window.location.href="sensus-household.html",800);
    } catch(e){
      console.error(e);
      enqueueCensus(data);
      showToast("‚ö† Save failed, cached offline");
      setTimeout(()=>window.location.href="sensus-household.html",800);
    }
  } else {
    enqueueCensus(data);
    showToast("‚ö† Offline: saved locally");
    setTimeout(()=>window.location.href="sensus-household.html",800);
  }
};
</script>
</body>
</html>
