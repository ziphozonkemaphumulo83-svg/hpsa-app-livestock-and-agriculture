<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sales Report Entry</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#774936">
  <link href="https://fonts.googleapis.com/css2?family=Uber+Move:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* KEEP ORIGINAL STYLES */
    body { background:#000; color:#fff; font-family:'Uber Move',sans-serif; display:flex; justify-content:center; padding:20px; }
    .container { max-width:450px; width:100%; background:#111; padding:20px; border-radius:16px; box-shadow:0 0 20px rgba(255,255,255,0.05); }
    h1 { text-align:center; margin-bottom:20px; }
    .form-group { margin-bottom:14px; }
    label { display:block; font-size:14px; margin-bottom:6px; color:#ccc; }
    input, select { width:100%; padding:10px; border-radius:10px; border:1px solid #444; background:#222; color:#fff; }
    input[readonly] { background:#1c1c1c; color:#ccc; }
    button { width:100%; padding:12px; margin-top:10px; border:none; border-radius:10px; background:#774936; color:#fff; font-weight:bold; cursor:pointer; }
    button:hover { background:#5e3729; }
    .summary h3 { font-weight:400; margin:8px 0; }
    .actions { margin-top:18px; display:flex; flex-direction:column; gap:10px; }
    .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#774936; color:white; padding:10px 20px; border-radius:10px; z-index:9999; display:none; }
    .modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000; display:none; }
    .modal-content { background:#222; padding:20px; border-radius:12px; box-shadow:0 0 10px rgba(255,255,255,0.1); text-align:center; }
  </style>
</head>
<body>
<div class="container">
  <h1>Sales Report</h1>
  <form id="summaryForm">
    <div class="form-group"><label>Date</label><input type="date" id="saleDate" required readonly /></div>
    <div class="form-group"><label>Farmer Name</label><input type="text" id="farmerName" required /></div>
    <div class="form-group"><label>Project Code</label><input type="text" id="projectCode" required readonly /></div>
    <div class="form-group"><label>Dip Tank</label><input type="text" id="dipTank" required /></div>
    <div class="form-group"><label>Animal Type</label>
      <select id="animalType" required>
        <option value="">Select</option>
        <option value="goat">Goat 🐐</option>
        <option value="chicken">Chicken 🐓</option>
      </select>
    </div>
    <div class="form-group"><label>Number of Animals</label><input type="number" id="animalCount" required /></div>
    <div class="form-group"><label>Amount (Rands)</label><input type="number" id="totalAmount" required /></div>
    <div class="form-group"><label>Youth Payment (Rands)</label><input type="number" id="youthPayment" required /></div>
    <div class="form-group"><label>Payment Method</label>
      <select id="paymentMethod" required>
        <option value="">Select</option>
        <option value="cash">Cash 💵</option>
        <option value="machine">Machine 📥️</option>
      </select>
    </div>
    <button type="submit">Submit Sale</button>
  </form>

  <div class="summary">
    <h3>🐐 Total Goats: <span id="totalGoats">0</span></h3>
    <h3>🐓 Total Chickens: <span id="totalChickens">0</span></h3>
    <h3>💰 Total Sales: R<span id="totalSales">0.00</span></h3>
    <h3>🧒 Youth Payments: R<span id="totalYouth">0.00</span></h3>
    <h3>💵 Cash: R<span id="cashTotal">0.00</span> | 📥️ Machine: R<span id="machineTotal">0.00</span></h3>
  </div>

  <div class="actions">
    <button type="button" id="clearBtn">Clear Form</button>
    <button type="button" id="logoutBtn">Logout</button>
  </div>
</div>

<!-- Logout Modal -->
<div id="logoutConfirm" class="modal-overlay">
  <div class="modal-content">
    <p style="color:#f2d0b5;">Are you sure you want to logout?</p>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="confirmLogout()" style="flex:1;">Yes</button>
      <button onclick="closeLogoutPopup()" style="flex:1; background:#444;">Cancel</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, where, enableIndexedDbPersistence, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCaOrMKZXZtJKD646bARehuTOxCe4DzsLk",
  authDomain: "hpsa-app-6b2d2.firebaseapp.com",
  projectId: "hpsa-app-6b2d2",
  storageBucket: "hpsa-app-6b2d2.appspot.com",
  messagingSenderId: "445389782453",
  appId: "1:445389782453:web:595647fa1038fab9886dfc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Enable offline persistence
enableIndexedDbPersistence(db).catch(err => console.warn("Persistence error:", err));

const form = document.getElementById("summaryForm");
const saleDate = document.getElementById("saleDate");
const farmerName = document.getElementById("farmerName");
const projectCode = document.getElementById("projectCode");
const dipTank = document.getElementById("dipTank");
const animalType = document.getElementById("animalType");
const animalCount = document.getElementById("animalCount");
const totalAmount = document.getElementById("totalAmount");
const youthPayment = document.getElementById("youthPayment");
const paymentMethod = document.getElementById("paymentMethod");

const totalGoats = document.getElementById("totalGoats");
const totalChickens = document.getElementById("totalChickens");
const totalSales = document.getElementById("totalSales");
const totalYouth = document.getElementById("totalYouth");
const cashTotal = document.getElementById("cashTotal");
const machineTotal = document.getElementById("machineTotal");
const toast = document.getElementById("toast");

// Default date
saleDate.value = new Date().toISOString().split("T")[0];

function showToast(msg){
  toast.textContent = msg; toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3500);
}

// Offline save
function saveOfflineSale(sale){
  const offline = JSON.parse(localStorage.getItem("offlineSales")||"[]");
  offline.push(sale);
  localStorage.setItem("offlineSales",JSON.stringify(offline));
  showToast("💾 Offline sale saved. Will sync when online.");
  form.reset(); saleDate.value=new Date().toISOString().split("T")[0]; lockProjectCode(sale.projectCode);
  if('serviceWorker' in navigator && 'SyncManager' in window){
    navigator.serviceWorker.ready.then(reg=>reg.sync.register('sync-offline-sales').catch(console.warn));
  }
}

// Online sync
window.addEventListener("online", async ()=>{
  const offline = JSON.parse(localStorage.getItem("offlineSales")||"[]");
  if(!offline.length) return;
  for(const s of offline){
    try{ await addDoc(collection(db,"sales-report"),s); } catch(err){ console.error(err); return; }
  }
  localStorage.removeItem("offlineSales");
  showToast("✅ Offline sales synced!");
});

// Lock project code
function lockProjectCode(pc){ projectCode.value=pc||""; projectCode.readOnly=true; }

// Submit form
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const sale = {
    date:saleDate.value,
    name:farmerName.value.trim(),
    projectCode:projectCode.value.trim(),
    dipTank:dipTank.value.trim(),
    animalType:animalType.value,
    count:parseInt(animalCount.value,10),
    amount:parseFloat(totalAmount.value),
    youthPayment:parseFloat(youthPayment.value),
    method:paymentMethod.value,
    timestamp:new Date().toISOString()
  };
  if(!navigator.onLine){ saveOfflineSale(sale); showToast("📴 Offline mode"); return; }
  try{ await addDoc(collection(db,"sales-report"),sale); showToast("✅ Sale submitted!"); form.reset(); saleDate.value=new Date().toISOString().split("T")[0]; lockProjectCode(sale.projectCode); } 
  catch(err){ console.error(err); saveOfflineSale(sale); }
});

// Clear / logout buttons
document.getElementById("clearBtn").addEventListener("click", ()=>{
  const pc=projectCode.value;
  form.reset(); saleDate.value=new Date().toISOString().split("T")[0]; lockProjectCode(pc);
});
document.getElementById("logoutBtn").addEventListener("click", ()=>document.getElementById("logoutConfirm").style.display="flex");
window.confirmLogout = ()=>{ signOut(auth).then(()=>{ localStorage.clear(); window.location.href="index.html"; }).catch(()=>showToast("Logout failed")); };
window.closeLogoutPopup = ()=>document.getElementById("logoutConfirm").style.display="none";

// Bind summary for project
let summaryUnsub=null;
function bindSummary(project){
  if(!project) return;
  if(summaryUnsub) summaryUnsub();
  const q=query(collection(db,"sales-report"),where("projectCode","==",project));
  summaryUnsub=onSnapshot(q,snap=>{
    let goats=0,chickens=0,sales=0,youth=0,cash=0,machine=0;
    snap.forEach(d=>{
      const data=d.data();
      if(data.animalType==="goat") goats+=data.count||0;
      if(data.animalType==="chicken") chickens+=data.count||0;
      sales+=data.amount||0;
      youth+=data.youthPayment||0;
      if(data.method==="cash") cash+=data.amount||0;
      if(data.method==="machine") machine+=data.amount||0;
    });
    totalGoats.textContent=goats;
    totalChickens.textContent=chickens;
    totalSales.textContent=sales.toFixed(2);
    totalYouth.textContent=youth.toFixed(2);
    cashTotal.textContent=cash.toFixed(2);
    machineTotal.textContent=machine.toFixed(2);
  },err=>console.error(err));
}

// Auth
onAuthStateChanged(auth,user=>{
  if(!user){ window.location.href="index.html"; return; }
  let pc=localStorage.getItem("projectCode")||"";
  if(!pc){
    getDoc(doc(db,"users",user.uid)).then(snap=>{ if(snap.exists()&&snap.data().projectCode){ pc=snap.data().projectCode.trim(); localStorage.setItem("projectCode",pc); lockProjectCode(pc); bindSummary(pc); } });
  } else { lockProjectCode(pc); bindSummary(pc); }
});

// Register Service Worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(()=>console.log("SW registered")).catch(console.warn);
}
</script>
</body>
</html>
