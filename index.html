<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>HPSA App</title>
<link href="https://fonts.googleapis.com/css2?family=Uber+Move:wght@400;700&display=swap" rel="stylesheet">
<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<!-- App Icons -->
<link rel="icon" type="image/png" sizes="192x192" href="images/icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="images/icon-512.png">

<!-- Apple iOS Support -->
<link rel="apple-touch-icon" sizes="192x192" href="images/icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="images/icon-512.png">
<meta name="theme-color" content="#002147">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
/* THEME */
:root{
  --navy-900:#002C5F; --navy-800:#003A73;
  --accent-red:#e63946; --green:#00A99D;
  --light-brown:#7EDDD3; --white:#ffffff;
  --shadow:0 10px 25px rgba(0,44,95,0.35);
  --brand-color: #1e88e5; 
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Uber Move',sans-serif;
  background:linear-gradient(135deg,#14243d,#0b1320);
  color:var(--white);
  overflow:hidden;
}

.splash-wrap {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  background: linear-gradient(135deg, #0b1320, #14243d, #0b1320);
  background-size: 400% 400%;
  animation: bgShift 14s ease infinite;
  z-index: 9999;
}

@keyframes bgShift {
  0%,100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.splash-title {
  font-size: 3rem;
  font-weight: bold;
  color: var(--brand-color);
  text-shadow: 0 0 20px rgba(30,136,229,0.7);
}

#fadeMessage {
  font-size: 1.2rem;
  font-weight: 400;
  max-width: 700px;
  text-align: center;
  opacity: 0;
}
/* Report Modal */
#reportModal .form-wrap {
  max-width: 420px;
  width: 90%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

#reportModal .panel {
  width: 100%;
  max-width: 360px;
  border-radius: 18px;
  padding: 22px;
  background: var(--light-brown);
  color: var(--navy-900);
  box-shadow: var(--shadow);
}



.app{position:relative;width:100%;height:100%;max-width:480px;margin:0 auto;box-shadow:0 10px 30px rgba(0,0,0,.35);}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:0;pointer-events:none;transform:translateY(10px) scale(.98);transition:opacity .4s ease, transform .4s ease;padding:18px;text-align:center;}
.screen.show{opacity:1;pointer-events:auto;transform:none;}
/* SPLASH */
/* SPLASH */
.splash-wrap {
  position: relative;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg,#14243d,#0b1320);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  overflow: hidden;
}
.sweep{width:min(82vw,460px);aspect-ratio:5/3;}
.sweep path{fill:none;stroke:url(#arcGradient);stroke-width:2.2;stroke-dasharray:260;stroke-dashoffset:260;animation:arcDraw 3000ms ease forwards 1000ms;filter:drop-shadow(0 0 8px rgba(0,200,255,.35));}
@keyframes arcDraw{to{stroke-dashoffset:0}}
.spark{offset-path:path("M10,70 A40,40 0 0,1 90,70");width:10px;height:10px;border-radius:50%;background:radial-gradient(circle,#fff,rgba(255,255,255,.6) 40%,rgba(255,255,255,0) 70%);filter:drop-shadow(0 0 6px #6cf);position:absolute;top:0;left:0;animation:sparkRun 2500ms ease-in-out 1300ms forwards;opacity:0;}
@keyframes sparkRun{0%{opacity:0;offset-distance:0%}10%{opacity:1}90%{opacity:1}100%{opacity:0;offset-distance:100%}}
/* Put HPSA text in absolute center */
.splash-title {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: clamp(36px, 10vw, 64px);
  font-weight: 900;
  letter-spacing: .36em;
  text-transform: uppercase;
  background: linear-gradient(90deg,#ff007f,#ffae00,#00e5ff,#9d00ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  opacity: 0;
  filter: blur(8px);
  animation: titleIn 2200ms cubic-bezier(.16,1,.3,1) forwards 2800ms;
}

.particle {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 6px;
  background: var(--brand-color);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--brand-color);
  opacity: 1;
  transform: translate(0, 0);
  transition: transform 1.5s ease-out, opacity 1.5s ease;
  pointer-events: none;
}


/* keep translate(-50%, -50%) so text stays centered */
@keyframes titleIn {
  to {
    opacity: 1;
    transform: translate(-50%, -50%);
    filter: blur(0);
  }
}/* HOME */
.hpsa-logo{width:68%;max-width:280px;margin:30px auto 12px;display:block;filter:drop-shadow(0 6px 14px rgba(0,0,0,0.45));}
.hero{text-align:center;margin-bottom:18px;padding:0 10px;}
.hero h1{font-size:22px;font-weight:800;margin-top:8px;}
.hero p{font-size:14px;color:rgba(255,255,255,0.85);max-width:320px;margin:8px auto 0;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;max-width:420px;margin:0 auto;}
.card{border-radius:16px;padding:14px;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:var(--shadow);cursor:pointer;transition:.2s;min-height:72px;}
.card:hover{transform:translateY(-2px);opacity:.95}
.icon{width:38px;height:38px;border-radius:10px;background:var(--navy-800);display:grid;place-items:center;color:#fff}
.label{font-weight:700;font-size:14px;}
.footer{margin-top:24px;padding:10px;font-size:12px;text-align:center;color:#9aa3ad;}
/* FORMS */
.form-wrap{max-width:420px;margin:auto;padding:70px 16px 40px;display:flex;justify-content:center;}
.panel{background:var(--light-brown);color:var(--navy-900);border-radius:18px;box-shadow:var(--shadow);padding:22px;width:100%;}
.panel h2{text-align:center;font-size:18px;margin-bottom:12px;font-weight:800;}
.field{margin-bottom:12px;}
.field label{font-size:12px;font-weight:700;margin-bottom:6px;display:block;}
.field input{width:100%;padding:12px;border:1px solid #ccc;border-radius:10px;}
.cta{width:100%;padding:14px;background:linear-gradient(90deg,var(--accent-red),var(--navy-800));color:#fff;font-weight:800;border:none;border-radius:12px;cursor:pointer;}
.muted-link{font-size:13px;margin-top:10px;cursor:pointer;text-align:center;color:var(--navy-900);}
.home-btn{width:36px;height:36px;border-radius:12px;background:var(--navy-800);display:grid;place-items:center;color:#fff;cursor:pointer;margin-bottom:12px;font-size:18px;}
/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--navy-800);color:#fff;padding:10px 14px;border-radius:10px;font-size:13px;opacity:0;transition:opacity .3s ease;z-index:9999;}
.toast.show{opacity:1;}
/* MODAL */
.project-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60;}
.project-modal.show{display:flex;}
.project-modal .inner{background:#fff;color:#222;padding:18px;border-radius:12px;width:90%;max-width:360px;box-shadow:0 8px 24px rgba(0,0,0,0.25);}
.project-modal input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;margin-top:8px;}
.project-modal button{margin-top:12px;padding:10px 12px;border-radius:8px;border:none;background:#0077cc;color:#fff;cursor:pointer;}
.fade-message {
  transition: opacity 1s ease;
}


</style>
</head>
<body>
<div class="app">

  <!-- SPLASH -->
  <section class="screen show" id="splash">
    <div class="splash-wrap">
      <svg class="sweep" viewBox="0 0 90 90" aria-hidden="true">
        <defs>
          <linearGradient id="arcGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#59f"/>
            <stop offset="30%" stop-color="#4cf"/>
            <stop offset="60%" stop-color="#7ef"/>
            <stop offset="100%" stop-color="#fff"/>
          </linearGradient>
        </defs>
        <path d="M10,70 A40,40 0 0,1 90,70"/>
      </svg>
      <div class="spark"></div>
      <h1 class="splash-title">HPSA</h1>
      <div id="fadeMessage" class="fade-message"></div>
    </div>
  </section>


  <!-- HOME -->
  <section class="screen" id="home">
    <div class="hero">
      <img src="images/hpsa-logo-transparent.png" alt="HPSA Logo" class="hpsa-logo">
      <h1>Welcome to HPSA</h1>
      <p>Your livestock, census & sales ‚Äî simplified and professional.</p>
    </div>
    <div class="grid">
      <div class="card" style="background:linear-gradient(135deg,#ff416c,#ff4b2b)" onclick="navigate('login')">
        <div class="icon">üîë</div><div class="label">Login / Register</div>
      </div>
      <div class="card" style="background:linear-gradient(135deg,#36d1dc,#5b86e5)" onclick="goToPage('training-manual.html')">
        <div class="icon">üéì</div><div class="label">Training Manual</div>
      </div>
<div class="card" style="background:linear-gradient(135deg,#f7971e,#ffd200)" onclick="openProjectModal('SALES-REPORT')">
  <div class="icon">üíπ</div><div class="label">Sales Report</div>
</div>

<div class="card" style="background:linear-gradient(135deg,#8e2de2,#4a00e0)" onclick="openProjectModal('CENSUS-REPORT')">
  <div class="icon">üìä</div><div class="label">Census Report</div>
</div>
    </div>
    <footer class="footer"><p>üìç Southern Africa | üåç Powered by HPSA</p></footer>
  </section>

  <!-- LOGIN -->
  <section class="screen" id="login">
    <div class="form-wrap">
      <div class="panel">
        <div class="home-btn" onclick="navigate('home')">üè†</div>
        <h2>Welcome back</h2>
        <form id="loginForm">
          <div class="field"><label>Email</label><input id="loginEmail" type="email" required autocomplete="email"></div>
          <div class="field"><label>Password</label><input id="loginPassword" type="password" required autocomplete="current-password"></div>
          <div class="field"><label>Project Code</label><input type="text" id="loginProject" required></div>
          <button class="cta" type="submit">Login</button>
        </form>
        <div class="muted-link" onclick="navigate('register')">No account? Register</div>
        <div class="muted-link" onclick="navigate('reset')">Forgot password?</div>
      </div>
    </div>
  </section>

  <!-- REGISTER -->
  <section class="screen" id="register">
    <div class="form-wrap">
      <div class="panel">
        <div class="home-btn" onclick="navigate('home')">üè†</div>
        <h2>Create account</h2>
        <form id="registerForm">
          <div class="field"><label>Participant</label><input type="text" id="participant" required></div>
          <div class="field"><label>Project Code</label><input type="text" id="project" required></div>
          <div class="field"><label>Email</label><input type="email" id="email" required autocomplete="email"></div>
          <div class="field"><label>Password</label><input type="password" id="password" required autocomplete="new-password"></div>
          <button class="cta" type="submit">Register</button>
        </form>
      </div>
    </div>
  </section>

  <!-- RESET -->
  <section class="screen" id="reset">
    <div class="form-wrap">
      <div class="panel">
        <div class="home-btn" onclick="navigate('home')">üè†</div>
        <h2>Reset password</h2>
        <div class="field"><label>Email</label><input type="email" id="resetEmail" required></div>
        <button class="cta" id="resetBtn">Send Reset Link</button>
        <div class="muted-link" onclick="navigate('login')">Back to Login</div>
      </div>
    </div>
  </section>

<!-- REPORT MODAL -->
<section class="screen" id="reportModal">
  <div class="form-wrap">
    <div class="panel">
      <div class="home-btn" onclick="closeProjectModal()">üè†</div>
      <h2 id="reportModalTitle">Report Access</h2>
      <p id="reportModalDesc">Enter your email, password, and project code to access the report.</p>
      <form id="reportForm">
        <div class="field"><label>Email</label><input type="email" id="reportEmail" placeholder="Email" required></div>
        <div class="field"><label>Password</label><input type="password" id="reportPassword" placeholder="Password" required></div>
        <div class="field"><label>Project Code</label><input type="text" id="reportCodeInput" placeholder="Project Code" required></div>
        <button class="cta" type="submit">Access Report</button>
      </form>
    </div>
  </div>
</section>

  <!-- TOAST -->
  <div id="toast" class="toast"></div>

</div><!-- /.app -->

<!-- LOGIN -->
<script type="module">
// Firebase imports and config remain unchanged
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getAuth, setPersistence, browserLocalPersistence, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCaOrMKZXZtJKD646bARehuTOxCe4DzsLk",
  authDomain: "hpsa-app-6b2d2.firebaseapp.com",
  projectId: "hpsa-app-6b2d2",
  storageBucket: "hpsa-app-6b2d2.appspot.com",
  messagingSenderId: "445389782453",
  appId: "1:445389782453:web:595647fa1038fab9886dfc"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(()=>{});
setPersistence(auth, browserLocalPersistence).catch(()=>{});

// Screens
const screens = {
  splash: document.getElementById("splash"),
  home: document.getElementById("home"),
  login: document.getElementById("login"),
  register: document.getElementById("register"),
  reset: document.getElementById("reset")
};
function show(id){
  Object.values(screens).forEach(s => s?.classList.remove("show"));
  screens[id]?.classList.add("show");
}
window.navigate = show;
window.goToPage = url => window.location.href = url;

// Toast
function toast(msg, ms=2500){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), ms);
}
window.toast = toast;

// Splash animation remains unchanged
window.addEventListener("load", () => {
  const fade = document.getElementById("fadeMessage");
  const splashTitle = document.querySelector(".splash-title");
  const sweep = document.querySelector(".sweep");
  const spark = document.querySelector(".spark");
  const splashWrap = document.querySelector(".splash-wrap");

  function createParticles(x, y) {
    for (let i = 0; i < 30; i++) {
      const p = document.createElement("div");
      p.className = "particle";
      splashWrap.appendChild(p);
      const angle = Math.random() * Math.PI * 2;
      const distance = 60 + Math.random() * 80;
      const dx = Math.cos(angle) * distance;
      const dy = Math.sin(angle) * distance;
      p.style.transform = `translate(${x}px, ${y}px)`;
      requestAnimationFrame(() => {
        p.style.transform = `translate(${x+dx}px, ${y+dy}px)`;
        p.style.opacity = "0";
      });
      setTimeout(() => p.remove(), 1800);
    }
  }

  setTimeout(() => {
    if (splashTitle) {
      const rect = splashTitle.getBoundingClientRect();
      const cx = rect.left + rect.width/2 - window.innerWidth/2;
      const cy = rect.top + rect.height/2 - window.innerHeight/2;
      createParticles(cx, cy);
    }
    [splashTitle,sweep,spark].forEach(el=>{
      if(el){el.style.transition="opacity 1.2s ease,transform 1.2s ease";el.style.opacity="0";el.style.transform="scale(.9)";}
    });
  },6000);

  setTimeout(() => {
    fade.textContent = "Where tradition meets technology to transform livestock and agriculture sales into something faster, easier, and more connected";
    fade.style.opacity="1";
  },7000);

  setTimeout(() => fade.style.opacity="0",12000);

  setTimeout(() => {
    splashWrap.style.transition="opacity 1.5s ease,transform 1.5s ease";
    splashWrap.style.opacity="0"; splashWrap.style.transform="scale(1.1)";
    setTimeout(()=>show("home"),1400);
  },16000);
});


function openProjectModal(code){
  const title = code === "SALES-REPORT" ? "Sales Report Access" : "Census Report Access";
  const desc = code === "SALES-REPORT" ? 
    "Enter your email, password, and project code to access the sales report." :
    "Enter your email, password, and project code to access the census report.";

  document.getElementById("reportModalTitle").textContent = title;
  document.getElementById("reportModalDesc").textContent = desc;
  document.getElementById("reportEmail").value = "";
  document.getElementById("reportPassword").value = "";
  document.getElementById("reportCodeInput").value = "";
  show('reportModal');

  document.getElementById("reportForm").onsubmit = async (e) => {
    e.preventDefault();
    const email = document.getElementById("reportEmail").value.trim();
    const password = document.getElementById("reportPassword").value;
    const inputCode = document.getElementById("reportCodeInput").value.trim().toUpperCase();
    if(!email || !password || !inputCode) return toast("All fields are required");

    try{
      const userCred = await signInWithEmailAndPassword(auth, email, password);
      const userDoc = await getDoc(doc(db,"users",userCred.user.uid));
      const userProject = userDoc.exists() ? userDoc.data().project : null;

      if(inputCode === code && userProject === code){
        toast("‚úÖ Access granted. Redirecting...");
        setTimeout(()=>{ 
          closeProjectModal(); 
          window.location.href = code === "SALES-REPORT" ? "sales-summary.html" : "sensus-report.html"; 
        },800);
      } else {
        toast("‚ùå Not authorized for this report");
      }
    } catch(err){
      toast(err.message || "Login failed");
    }
  }
}

function closeProjectModal(){
  show('home');
}

// Register logic remains unchanged
document.getElementById("registerForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const name=document.getElementById("participant").value.trim();
  const project=document.getElementById("project").value.trim().toUpperCase();
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value;
  try{
    const userCred=await createUserWithEmailAndPassword(auth,email,password);
    await setDoc(doc(db,"users",userCred.user.uid),{name,project,email,createdAt:Date.now()});
    toast("‚úÖ Registered successfully!");
    show("home");
  }catch(err){toast(err.message||"Registration error");}
});

// Login fixes: corrected file paths
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;
  const project = document.getElementById("loginProject").value.trim().toUpperCase();
  if (!project) return toast("Enter your Project Code");

  try {
    await signInWithEmailAndPassword(auth, email, password);
    toast("‚úÖ Login successful");

    if (project === "CENSUS") {
      window.location.href = "sensus.html";
    } else if (project === "PYEI") {
      window.location.href = "sales-summary.html";
    } else if (project === "CENSUS-REPORT") {
      window.location.href = "sensus-report.html";
    } else if (project === "SALES-REPORT") {
      window.location.href = "sales-summary.html";
    } else {
      show("home");
    }
  } catch (err) {
    toast(err.message || "Login failed");
  }
});

// Reset remains unchanged
document.getElementById("resetBtn").addEventListener("click", async ()=>{
  const email=document.getElementById("resetEmail").value.trim();
  if(!email) return toast("Enter your email");
  try{
    await sendPasswordResetEmail(auth,email);
    toast("‚úÖ Reset link sent");
    show('login');
  }catch(err){ toast(err.message || "Reset failed"); }
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(() => console.log("Service Worker registered"))
    .catch((err) => console.error("Service Worker registration failed:", err));
}
</script>
</body>
</html>
